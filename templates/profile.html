{% extends "layout.html" %} {% block head %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/profilestyle.css') }}"
/>
{% endblock %} {% block content %}
<div class="profile-wrapper">
  <header class="profile-header">
    <div class="banner" id="profileBanner"></div>
    <div class="avatar-wrap">
      {% set pfp = session.get('profile_picture', 'avatar.jpg') %}
      <img
        id="profileAvatar"
        src="{{ url_for('static', filename=('uploads/' + pfp) if not pfp.startswith('avatar') else 'images/' + pfp) }}"
        alt="Avatar"
      />
    </div>
    <button class="edit-btn" id="actionBtn">
      <img
        src="https://img.icons8.com/forma-regular/16/FFFFFF/edit.png"
        alt="edit"
        style="vertical-align: middle; margin-right: 6px"
      />
      Edit profile
    </button>
  </header>

  <section class="profile-info">
    <h1 id="profileName">{{ session.get('name', 'Your Name') }}</h1>
    <span class="handle" id="profileHandle"
      >@{{ session.get('username', 'username') }}</span
    >
    <p class="bio" id="profileBio">
      <img
        src="https://img.icons8.com/forma-regular/16/71767b/calendar.png"
        alt="joined"
        style="vertical-align: middle"
      />
      Joined <span id="joinedDate">September 2011</span>
    </p>
    <div class="stats">
      <span><strong id="followingCount">0</strong> Following</span>
      <span><strong id="followerCount">0</strong> Followers</span>
    </div>
  </section>

  <nav class="profile-tabs">
    <button class="tab-button active" data-tab="tweets">Tweets</button>
    <button class="tab-button" data-tab="replies">Tweets & replies</button>
    <button class="tab-button" data-tab="media">Media</button>
    <button class="tab-button" data-tab="likes">Likes</button>
  </nav>

  <section class="profile-feed" id="profileFeed">
    <div style="padding: 32px; text-align: center; color: #71767b">
      Loading posts...
    </div>
  </section>
</div>

<script>
  const profileUsername = '{{ profile_username }}';
  const currentUsername = '{{ session.get("username", "") }}';
  const currentUserId = {{ session.get('user_id', 0) }};
  let profileUserId = null;
  let currentTab = 'tweets';
  let isOwnProfile = profileUsername === currentUsername;

  // Load profile data
  async function loadProfileData() {
    try {
      // First get user by username
      const usernameResponse = await fetch(`/api/user/${currentUserId}`);
      const tempData = await usernameResponse.json();

      // Find user by username from the session or use current user
      let targetUserId = currentUserId;

      if (!isOwnProfile) {
        // For other profiles, we need to search (simplified - in production you'd have a proper API)
        // For now, we'll try to get the user info directly
        targetUserId = currentUserId; // This is a limitation - you'd need a username lookup API
      }

      const response = await fetch(`/api/user/${targetUserId}`);
      const data = await response.json();

      if (data.success) {
        const user = data.user;
        profileUserId = user.userID;
        isOwnProfile = profileUserId === currentUserId;

        document.getElementById('profileName').textContent = user.name;
        document.getElementById('profileHandle').textContent = `@${user.username}`;
        document.getElementById('profileAvatar').src="{{ url_for('static', filename=('uploads/' + pfp) if not pfp.startswith('avatar') else 'images/' + pfp) }}";

        if (user.banner_picture) {
          document.getElementById('profileBanner').style.background = `url('/static/uploads/${user.banner_picture}') center/cover`;
        }

        // Update bio
        const bioElement = document.getElementById('profileBio');
        if (user.bio) {
          bioElement.innerHTML = `
            ${escapeHtml(user.bio)}<br/>
            <img src="https://img.icons8.com/forma-regular/16/71767b/calendar.png" alt="joined" style="vertical-align: middle; margin-top: 8px;" />
            Joined ${formatDate(user.created_at)}
          `;
        }

        document.getElementById('followingCount').textContent = user.following_count;
        document.getElementById('followerCount').textContent = user.followers_count;

        // Update action button
        const actionBtn = document.getElementById('actionBtn');
        if (isOwnProfile) {
          actionBtn.innerHTML = '<img src="https://img.icons8.com/forma-regular/16/FFFFFF/edit.png" alt="edit" style="vertical-align: middle; margin-right: 6px" />Edit profile';
          actionBtn.onclick = () => window.location.href = '/edit-profile';
        } else {
          if (user.is_following) {
            actionBtn.innerHTML = 'Following';
            actionBtn.style.background = 'transparent';
            actionBtn.style.border = '1px solid #536471';
            actionBtn.onclick = () => unfollowUser(profileUserId);
          } else {
            actionBtn.innerHTML = 'Follow';
            actionBtn.style.background = '#eff3f4';
            actionBtn.style.color = '#0f1419';
            actionBtn.style.border = 'none';
            actionBtn.onclick = () => followUser(profileUserId);
          }
        }

        // Load posts
        loadTabContent('tweets');
      }
    } catch (error) {
      console.error('Error loading profile:', error);
    }
  }

  // Follow user
  async function followUser(userId) {
    try {
      const response = await fetch(`/api/user/${userId}/follow`, {
        method: 'POST'
      });
      const data = await response.json();

      if (data.success) {
        loadProfileData();
      }
    } catch (error) {
      console.error('Error following user:', error);
    }
  }

  // Unfollow user
  async function unfollowUser(userId) {
    try {
      const response = await fetch(`/api/user/${userId}/unfollow`, {
        method: 'POST'
      });
      const data = await response.json();

      if (data.success) {
        loadProfileData();
      }
    } catch (error) {
      console.error('Error unfollowing user:', error);
    }
  }

  // Tab switching
  const tabButtons = document.querySelectorAll('.tab-button');
  const profileFeed = document.getElementById('profileFeed');

  tabButtons.forEach(button => {
    button.addEventListener('click', () => {
      tabButtons.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      currentTab = button.dataset.tab;
      loadTabContent(currentTab);
    });
  });

  // Load tab content
  async function loadTabContent(tab) {
    profileFeed.innerHTML = `
      <div style="padding: 32px; text-align: center; color: #71767b;">
        Loading...
      </div>
    `;

    switch(tab) {
      case 'tweets':
        await loadUserPosts();
        break;
      case 'replies':
        showComingSoon('Tweets & replies');
        break;
      case 'media':
        await loadUserMediaPosts();
        break;
      case 'likes':
        await loadUserLikedPosts();
        break;
    }
  }

  // Load user posts
  async function loadUserPosts() {
    try {
      const response = await fetch(`/api/posts/user/${profileUserId || currentUserId}`);
      const data = await response.json();

      if (data.success && data.posts.length > 0) {
        profileFeed.innerHTML = '';
        data.posts.forEach(post => {
          const tweetEl = createTweetElement(post);
          profileFeed.appendChild(tweetEl);
        });
      } else {
        profileFeed.innerHTML = `
          <div class="empty-state">
            ${isOwnProfile ? "You haven't posted any media yet." : "No media posts yet."}
          </div>
        `;
      }
    } catch (error) {
      console.error('Error loading media posts:', error);
      profileFeed.innerHTML = `
        <div style="padding: 32px; text-align: center; color: #f4212e;">
          Error loading posts. Please refresh the page.
        </div>
      `;
    }
  }

  // Load user liked posts
  async function loadUserLikedPosts() {
    try {
      const response = await fetch(`/api/posts/user/${profileUserId || currentUserId}/likes`);
      const data = await response.json();

      if (data.success && data.posts.length > 0) {
        profileFeed.innerHTML = '';
        data.posts.forEach(post => {
          const tweetEl = createTweetElement(post);
          profileFeed.appendChild(tweetEl);
        });
      } else {
        profileFeed.innerHTML = `
          <div class="empty-state">
            ${isOwnProfile ? "You haven't liked any posts yet." : "No liked posts yet."}
          </div>
        `;
      }
    } catch (error) {
      console.error('Error loading liked posts:', error);
      profileFeed.innerHTML = `
        <div style="padding: 32px; text-align: center; color: #f4212e;">
          Error loading posts. Please refresh the page.
        </div>
      `;
    }
  }

  // Show coming soon message
  function showComingSoon(feature) {
    profileFeed.innerHTML = `
      <div class="empty-state">
        ${feature} feature coming soon! ðŸš€
      </div>
    `;
  }

  // Create tweet element
  function createTweetElement(post) {
    const article = document.createElement('article');
    article.className = 'tweet-card';

    const timeAgo = getTimeAgo(post.created_at);
    const isOwnPost = post.userID === currentUserId;

    let mediaHtml = '';
    if (post.media_url) {
      mediaHtml = `
        <div class="tweet-media">
          <img src="${post.media_url}" alt="Post media" style="width: 100%; border-radius: 16px; margin-top: 12px;" />
        </div>
      `;
    }

    article.innerHTML = `
      <div class="tweet-card-header">
        {% set pfp = session.get('profile_picture', 'avatar.jpg') %}
        <img
          src="${
          post.profile_picture.startsWith("avatar")
            ? "/static/images/" + escapeHtml(post.profile_picture)
            : "/static/uploads/" + escapeHtml(post.profile_picture)
        }"
          alt="User avatar"
          class="tweet-card-avatar"
        />
        <div style="flex: 1; min-width: 0;">
          <div class="tweet-card-info">
            <span class="tweet-card-name">${escapeHtml(post.name)}</span>
            <span class="tweet-card-username">@${escapeHtml(post.username)}</span>
            <span class="tweet-card-time">Â· ${timeAgo}</span>
          </div>
        </div>
        ${isOwnPost ? `
        <button
          class="delete-post-btn"
          onclick="deletePost(${post.postID})"
          style="background: transparent; border: none; color: #71767b; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s;"
          onmouseover="this.style.color='#f4212e'; this.style.background='rgba(244, 33, 46, 0.1)'"
          onmouseout="this.style.color='#71767b'; this.style.background='transparent'"
        >
          <img src="https://img.icons8.com/forma-regular/16/71767b/trash.png" alt="delete" style="vertical-align: middle;" />
        </button>
        ` : ''}
      </div>
      <div class="tweet-card-content">${escapeHtml(post.content)}</div>
      ${mediaHtml}
      <div class="tweet-card-actions">
        <button>
          <img src="https://img.icons8.com/forma-regular/18/71767b/speech-bubble.png" alt="reply" />
          <span>0</span>
        </button>
        <button>
          <img src="https://img.icons8.com/forma-regular/18/71767b/retweet.png" alt="retweet" />
          <span>0</span>
        </button>
        <button onclick="toggleLike(${post.postID}, this)" class="${post.is_liked ? 'liked' : ''}">
          <img src="https://img.icons8.com/forma-regular/18/${post.is_liked ? 'f4212e' : '71767b'}/like.png" alt="like" />
          <span style="color: ${post.is_liked ? '#f4212e' : '#71767b'}">${post.like_count}</span>
        </button>
        <button>
          <img src="https://img.icons8.com/forma-regular/18/71767b/share.png" alt="share" />
        </button>
      </div>
    `;

    return article;
  }

  // Toggle like
  async function toggleLike(postId, button) {
    const isLiked = button.classList.contains('liked');
    const endpoint = isLiked ? `/api/posts/${postId}/unlike` : `/api/posts/${postId}/like`;

    try {
      const response = await fetch(endpoint, { method: 'POST' });
      const data = await response.json();

      if (data.success || !isLiked) {
        loadTabContent(currentTab);
      }
    } catch (error) {
      console.error('Error toggling like:', error);
    }
  }

  // Delete post
  async function deletePost(postId) {
    if (!confirm('Are you sure you want to delete this post?')) {
      return;
    }

    try {
      const response = await fetch(`/api/posts/${postId}`, {
        method: 'DELETE'
      });

      const data = await response.json();

      if (data.success) {
        loadTabContent(currentTab);
      } else {
        alert(data.message || 'Error deleting post');
      }
    } catch (error) {
      console.error('Error deleting post:', error);
      alert('Error deleting post. Please try again.');
    }
  }

  // Helper functions
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function getTimeAgo(timestamp) {
    const now = new Date();
    const posted = new Date(timestamp);
    const seconds = Math.floor((now - posted) / 1000);

    if (seconds < 60) return `${seconds}s`;
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h`;
    if (seconds < 604800) return `${Math.floor(seconds / 86400)}d`;

    return posted.toLocaleDateString();
  }

  function formatDate(timestamp) {
    const date = new Date(timestamp);
    const options = { month: 'long', year: 'numeric' };
    return date.toLocaleDateString('en-US', options);
  }

  // Load profile data on page load
  loadProfileData();
</script>
{% endblock %}); }); } else { profileFeed.innerHTML = `
<div class="empty-state">
  ${isOwnProfile ? "You haven't posted anything yet. Share your first tweet!" :
  "No posts yet."}
</div>
`; } } catch (error) { console.error('Error loading posts:', error);
profileFeed.innerHTML = `
<div style="padding: 32px; text-align: center; color: #f4212e">
  Error loading posts. Please refresh the page.
</div>
`; } } // Load user media posts async function loadUserMediaPosts() { try {
const response = await fetch(`/api/posts/user/${profileUserId ||
currentUserId}/media`); const data = await response.json(); if (data.success &&
data.posts.length > 0) { profileFeed.innerHTML = ''; data.posts.forEach(post =>
{ const tweetEl = createTweetElement(post); profileFeed.appendChild(tweetEl
