{% extends 'layout.html' %} {% block content %}
<div class="home-wrapper">
  <header class="home-header">
    <h2>Home</h2>
  </header>

  <!-- Tweet Composer -->
  <div class="tweet-composer">
    <img
      src="{{ url_for('static', filename='images/avatar.jpg') }}"
      alt="Your avatar"
      class="composer-avatar"
    />
    <form class="composer-form" id="tweetForm">
      <textarea
        id="tweetContent"
        placeholder="What's happening?"
        maxlength="280"
      ></textarea>
      <div class="composer-actions">
        <div class="composer-icons">
          <button type="button" title="Add photo">
            <img
              src="https://img.icons8.com/forma-regular/18/1da1f2/image.png"
              alt="image"
            />
          </button>
          <button type="button" title="Add GIF">
            <img
              src="https://img.icons8.com/forma-regular/18/1da1f2/gif.png"
              alt="gif"
            />
          </button>
          <button type="button" title="Add poll">
            <img
              src="https://img.icons8.com/forma-regular/18/1da1f2/poll-topic.png"
              alt="poll"
            />
          </button>
          <button type="button" title="Add emoji">
            <img
              src="https://img.icons8.com/forma-regular/18/1da1f2/happy.png"
              alt="emoji"
            />
          </button>
        </div>
        <div style="display: flex; align-items: center; gap: 12px">
          <span id="charCount" style="color: #71767b; font-size: 13px"
            >280</span
          >
          <button type="submit" class="tweet-post-btn" id="tweetBtn">
            Tweet
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Feed -->
  <div class="feed" id="feed">
    <!-- Posts will be loaded here dynamically -->
    <div style="padding: 32px; text-align: center; color: #71767b">
      Loading posts...
    </div>
  </div>
</div>

<script>
  // Character counter
  const textarea = document.getElementById("tweetContent");
  const charCount = document.getElementById("charCount");
  const tweetBtn = document.getElementById("tweetBtn");

  textarea.addEventListener("input", () => {
    const remaining = 280 - textarea.value.length;
    charCount.textContent = remaining;

    if (remaining < 0) {
      charCount.style.color = "#f4212e";
      tweetBtn.disabled = true;
      tweetBtn.style.opacity = "0.5";
    } else if (remaining < 20) {
      charCount.style.color = "#ffd400";
      tweetBtn.disabled = false;
      tweetBtn.style.opacity = "1";
    } else {
      charCount.style.color = "#71767b";
      tweetBtn.disabled = false;
      tweetBtn.style.opacity = "1";
    }
  });

  // Load posts
  async function loadPosts() {
    try {
      const response = await fetch("/api/posts");
      const data = await response.json();

      const feed = document.getElementById("feed");

      if (data.success && data.posts.length > 0) {
        feed.innerHTML = "";

        data.posts.forEach((post) => {
          const tweetEl = createTweetElement(post);
          feed.appendChild(tweetEl);
        });
      } else {
        feed.innerHTML = `
          <div style="padding: 32px; text-align: center; color: #71767b;">
            No posts yet. Be the first to tweet!
          </div>
        `;
      }
    } catch (error) {
      console.error("Error loading posts:", error);
      document.getElementById("feed").innerHTML = `
        <div style="padding: 32px; text-align: center; color: #f4212e;">
          Error loading posts. Please refresh the page.
        </div>
      `;
    }
  }

  // Create tweet element
  function createTweetElement(post) {
    const article = document.createElement("article");
    article.className = "tweet";

    const timeAgo = getTimeAgo(post.created_at);
    const isOwnPost = post.username === '{{ session.get("username", "") }}';

    article.innerHTML = `
      <img
        src="{{ url_for('static', filename='images/avatar.jpg') }}"
        alt="User avatar"
        class="tweet-avatar"
      />
      <div class="tweet-content">
        <div class="tweet-header">
          <span class="tweet-name">${escapeHtml(post.name)}</span>
          <span class="tweet-username">@${escapeHtml(post.username)}</span>
          <span class="tweet-time">Â· ${timeAgo}</span>
          ${
            isOwnPost
              ? `
            <button 
              class="delete-post-btn" 
              onclick="deletePost(${post.postID})"
              style="margin-left: auto; background: transparent; border: none; color: #71767b; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s;"
              onmouseover="this.style.color='#f4212e'; this.style.background='rgba(244, 33, 46, 0.1)'"
              onmouseout="this.style.color='#71767b'; this.style.background='transparent'"
            >
              <img src="https://img.icons8.com/forma-regular/16/71767b/trash.png" alt="delete" style="vertical-align: middle;" />
            </button>
          `
              : ""
          }
        </div>
        <p class="tweet-text">${escapeHtml(post.content)}</p>
        <div class="tweet-actions">
          <button class="action-btn">
            <img
              src="https://img.icons8.com/forma-regular/18/71767b/speech-bubble.png"
              alt="reply"
              class="icon"
            />
            <span>0</span>
          </button>
          <button class="action-btn">
            <img
              src="https://img.icons8.com/forma-regular/18/71767b/retweet.png"
              alt="retweet"
              class="icon"
            />
            <span>0</span>
          </button>
          <button class="action-btn">
            <img
              src="https://img.icons8.com/forma-regular/18/71767b/like.png"
              alt="like"
              class="icon"
            />
            <span>0</span>
          </button>
          <button class="action-btn">
            <img
              src="https://img.icons8.com/forma-regular/18/71767b/share.png"
              alt="share"
              class="icon"
            />
          </button>
        </div>
      </div>
    `;

    return article;
  }

  // Delete post
  async function deletePost(postId) {
    if (!confirm("Are you sure you want to delete this post?")) {
      return;
    }

    try {
      const response = await fetch(`/api/posts/${postId}`, {
        method: "DELETE",
      });

      const data = await response.json();

      if (data.success) {
        loadPosts();
      } else {
        alert(data.message || "Error deleting post");
      }
    } catch (error) {
      console.error("Error deleting post:", error);
      alert("Error deleting post. Please try again.");
    }
  }

  // Submit tweet
  document.getElementById("tweetForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const content = textarea.value.trim();

    if (!content) {
      alert("Please enter some content");
      return;
    }

    if (content.length > 280) {
      alert("Post cannot exceed 280 characters");
      return;
    }

    tweetBtn.disabled = true;
    tweetBtn.textContent = "Posting...";

    try {
      const response = await fetch("/api/posts", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ content }),
      });

      const data = await response.json();

      if (data.success) {
        textarea.value = "";
        charCount.textContent = "280";
        charCount.style.color = "#71767b";
        loadPosts();
      } else {
        alert(data.message || "Error creating post");
      }
    } catch (error) {
      console.error("Error creating post:", error);
      alert("Error creating post. Please try again.");
    } finally {
      tweetBtn.disabled = false;
      tweetBtn.textContent = "Tweet";
    }
  });

  // Helper functions
  function escapeHtml(text) {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  function getTimeAgo(timestamp) {
    const now = new Date();
    const posted = new Date(timestamp);
    const seconds = Math.floor((now - posted) / 1000);

    if (seconds < 60) return `${seconds}s`;
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h`;
    if (seconds < 604800) return `${Math.floor(seconds / 86400)}d`;

    return posted.toLocaleDateString();
  }

  // Load posts on page load
  loadPosts();
</script>
{% endblock %}
