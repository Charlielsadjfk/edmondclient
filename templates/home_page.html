{% extends 'layout.html' %} {% block content %}
<div class="home-wrapper">
  <header class="home-header">
    <title>home</title>
    <h2>Sigma Reviews</h2>
  </header>

  <!-- post Composer -->
  {% set pfp = session.get('profile_picture', 'avatar.jpg') %}
  <div class="post-composer">
    <img
      src="{{ url_for('static', filename=('uploads/' + pfp) if not pfp.startswith('avatar') else 'images/' + pfp) }}"
      alt="Your avatar"
      class="composer-avatar"
    />
    <form class="composer-form" id="postForm">
      <textarea
        id="postContent"
        placeholder="What's happening?"
        maxlength="280"
      ></textarea>

      <!-- Media Preview -->
      <div id="mediaPreview" style="display: none; margin: 12px 0">
        <div style="position: relative; display: inline-block">
          <img
            id="previewImage"
            src=""
            alt="Preview"
            style="max-width: 100%; border-radius: 16px; max-height: 300px"
          />
          <button
            type="button"
            id="removeMedia"
            style="
              position: absolute;
              top: 8px;
              right: 8px;
              width: 32px;
              height: 32px;
              border-radius: 50%;
              background: rgba(0, 0, 0, 0.75);
              border: none;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
            "
          >
            <img
              src="https://img.icons8.com/forma-regular/16/FFFFFF/delete-sign.png"
              alt="remove"
            />
          </button>
        </div>
      </div>

      <div class="composer-actions">
        <div class="composer-icons">
          <label
            for="mediaUpload"
            title="Add photo"
            style="
              cursor: pointer;
              padding: 8px;
              display: inline-flex;
              align-items: center;
              justify-content: center;
              transition: background 0.2s;
            "
          >
            <img
              src="https://img.icons8.com/forma-regular/18/1da1f2/image.png"
              alt="image"
            />
            <input
              type="file"
              id="mediaUpload"
              accept="image/*"
              style="display: none"
            />
          </label>
          <a
            href="{{ url_for('coming_soon', feature='gif') }}"
            style="text-decoration: none"
          >
            <button type="button" title="Add GIF">
              <img
                src="https://img.icons8.com/forma-regular/18/1da1f2/gif.png"
                alt="gif"
              />
            </button>
          </a>
          <a
            href="{{ url_for('coming_soon', feature='poll') }}"
            style="text-decoration: none"
          >
            <button type="button" title="Add poll">
              <img
                src="https://img.icons8.com/forma-regular/18/1da1f2/poll-topic.png"
                alt="poll"
              />
            </button>
          </a>
          <a
            href="{{ url_for('coming_soon', feature='emoji') }}"
            style="text-decoration: none"
          >
            <button type="button" title="Add emoji">
              <img
                src="https://img.icons8.com/forma-regular/18/1da1f2/happy.png"
                alt="emoji"
              />
            </button>
          </a>
        </div>
        <div style="display: flex; align-items: center; gap: 12px">
          <span id="charCount" style="color: #71767b; font-size: 13px"
            >280</span
          >
          <button type="submit" class="post-post-btn" id="postBtn">Post</button>
        </div>
      </div>
    </form>
  </div>

  <!-- Feed -->
  <div class="feed" id="feed">
    <div style="padding: 32px; text-align: center; color: #71767b">
      Loading posts...
    </div>
  </div>
</div>

<script>
  const textarea = document.getElementById("postContent");
  const charCount = document.getElementById("charCount");
  const postBtn = document.getElementById("postBtn");
  const mediaUpload = document.getElementById("mediaUpload");
  const mediaPreview = document.getElementById("mediaPreview");
  const previewImage = document.getElementById("previewImage");
  const removeMedia = document.getElementById("removeMedia");

  let selectedMediaFile = null;
  let uploadedMediaUrl = null;
  let uploadedMediaType = null;

  // Character counter
  textarea.addEventListener("input", () => {
    const remaining = 280 - textarea.value.length;
    charCount.textContent = remaining;

    if (remaining < 0) {
      charCount.style.color = "#f4212e";
      postBtn.disabled = true;
      postBtn.style.opacity = "0.5";
    } else if (remaining < 20) {
      charCount.style.color = "#ffd400";
      postBtn.disabled = false;
      postBtn.style.opacity = "1";
    } else {
      charCount.style.color = "#71767b";
      postBtn.disabled = false;
      postBtn.style.opacity = "1";
    }
  });

  // Media upload
  mediaUpload.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
      selectedMediaFile = file;
      const reader = new FileReader();
      reader.onload = (event) => {
        previewImage.src = event.target.result;
        mediaPreview.style.display = "block";
      };
      reader.readAsDataURL(file);
    }
  });

  // Remove media
  removeMedia.addEventListener("click", () => {
    selectedMediaFile = null;
    uploadedMediaUrl = null;
    uploadedMediaType = null;
    mediaPreview.style.display = "none";
    previewImage.src = "";
    mediaUpload.value = "";
  });

  // Upload media to server
  async function uploadMedia(file) {
    const formData = new FormData();
    formData.append("file", file);

    const response = await fetch("/api/upload", {
      method: "POST",
      body: formData,
    });

    const data = await response.json();
    if (data.success) {
      return {
        url: data.media_url,
        type: data.media_type,
      };
    }
    throw new Error("Upload failed");
  }

  // Load posts
  async function loadPosts() {
    try {
      const response = await fetch("/api/posts");
      const data = await response.json();

      const feed = document.getElementById("feed");

      if (data.success && data.posts.length > 0) {
        feed.innerHTML = "";

        data.posts.forEach((post) => {
          const postEl = createpostElement(post);
          feed.appendChild(postEl);
        });
      } else {
        feed.innerHTML = `
          <div style="padding: 32px; text-align: center; color: #71767b;">
            No posts yet. Be the first to post!
          </div>
        `;
      }
    } catch (error) {
      console.error("Error loading posts:", error);
      document.getElementById("feed").innerHTML = `
        <div style="padding: 32px; text-align: center; color: #f4212e;">
          Error loading posts. Please refresh the page.
        </div>
      `;
    }
  }

  // Create post element
  function createpostElement(post) {
    const article = document.createElement("article");
    article.className = "post";

    const timeAgo = getTimeAgo(post.created_at);
    const isOwnPost = post.username === '{{ session.get("username", "") }}';

    let mediaHtml = "";
    if (post.media_url) {
      mediaHtml = `
        <div class="post-media" style="margin-top: 12px;">
          <img src="${post.media_url}" alt="Post media" style="width: 100%; border-radius: 16px; max-height: 400px; object-fit: cover;" />
        </div>
      `;
    }

    article.innerHTML = `
      <img
        src="${
          post.profile_picture.startsWith("avatar")
            ? "/static/images/" + escapeHtml(post.profile_picture)
            : "/static/uploads/" + escapeHtml(post.profile_picture)
        }"
        alt="User avatar"
        class="post-avatar"
        style="cursor: pointer;"
      />
      <div class="post-content">
        <div class="post-header">
          <span class="post-name" style="cursor: pointer;">${escapeHtml(
            post.name
          )}</span>
          <span class="post-username" style="cursor: pointer;">@${escapeHtml(
            post.username
          )}</span>
          <span class="post-time">Â· ${timeAgo}</span>
          ${
            isOwnPost
              ? `<button
                  class="delete-post-btn"
                  onclick="deletePost(${post.postID})"
                  style="background: transparent; border: none; color: #71767b; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s; margin-left: auto;"
                  onmouseover="this.style.color='#f4212e'; this.style.background='rgba(244, 33, 46, 0.1)'"
                  onmouseout="this.style.color='#71767b'; this.style.background='transparent'"
                >
                  <img src="https://img.icons8.com/forma-regular/16/71767b/trash.png" alt="delete" style="vertical-align: top;" />
                </button>`
              : ""
          }
        </div>
        <p class="post-text">${escapeHtml(post.content)}</p>
        ${mediaHtml}
        <div class="post-actions">
          <button class="action-btn">
            <img
              src="https://img.icons8.com/forma-regular/18/71767b/speech-bubble.png"
              alt="reply"
              class="icon"
            />
            <span>0</span>
          </button>
          <button class="action-btn">
            <img
              src="https://img.icons8.com/forma-regular/18/71767b/retweet.png"
              alt="retweet"
              class="icon"
            />
            <span>0</span>
          </button>
          <button class="action-btn ${
            post.is_liked ? "liked" : ""
          }" onclick="toggleLike(${post.postID}, this)">
            <img
              src="https://img.icons8.com/forma-regular/18/${
                post.is_liked ? "f4212e" : "71767b"
              }/like.png"
              alt="like"
              class="icon"
            />
            <span style="color: ${post.is_liked ? "#f4212e" : "#71767b"}">${
      post.like_count
    }</span>
          </button>
          <button class="action-btn">
            <img
              src="https://img.icons8.com/forma-regular/18/71767b/share.png"
              alt="share"
              class="icon"
            />
          </button>
        </div>
      </div>
    `;

    return article;
  }

  // Toggle like
  async function toggleLike(postId, button) {
    const isLiked = button.classList.contains("liked");
    const endpoint = isLiked
      ? `/api/posts/${postId}/unlike`
      : `/api/posts/${postId}/like`;

    try {
      const response = await fetch(endpoint, { method: "POST" });
      const data = await response.json();

      if (data.success || !isLiked) {
        loadPosts();
      }
    } catch (error) {
      console.error("Error toggling like:", error);
    }
  }

  // Delete post
  async function deletePost(postId) {
    if (!confirm("Are you sure you want to delete this post?")) {
      return;
    }

    try {
      const response = await fetch(`/api/posts/${postId}`, {
        method: "DELETE",
      });

      const data = await response.json();

      if (data.success) {
        loadPosts();
      } else {
        alert(data.message || "Error deleting post");
      }
    } catch (error) {
      console.error("Error deleting post:", error);
      alert("Error deleting post. Please try again.");
    }
  }

  // Submit post
  document.getElementById("postForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const content = textarea.value.trim();

    if (!content) {
      alert("Please enter some content");
      return;
    }

    if (content.length > 280) {
      alert("Post cannot exceed 280 characters");
      return;
    }

    postBtn.disabled = true;
    postBtn.textContent = "Posting...";

    try {
      // Upload media if selected
      if (selectedMediaFile) {
        const mediaData = await uploadMedia(selectedMediaFile);
        uploadedMediaUrl = mediaData.url;
        uploadedMediaType = mediaData.type;
      }

      const response = await fetch("/api/posts", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          content,
          media_url: uploadedMediaUrl,
          media_type: uploadedMediaType,
        }),
      });

      const data = await response.json();

      if (data.success) {
        textarea.value = "";
        charCount.textContent = "280";
        charCount.style.color = "#71767b";

        // Clear media
        selectedMediaFile = null;
        uploadedMediaUrl = null;
        uploadedMediaType = null;
        mediaPreview.style.display = "none";
        previewImage.src = "";
        mediaUpload.value = "";

        loadPosts();
      } else {
        alert(data.message || "Error creating post");
      }
    } catch (error) {
      console.error("Error creating post:", error);
      alert("Error creating post. Please try again.");
    } finally {
      postBtn.disabled = false;
      postBtn.textContent = "Post";
    }
  });

  // Helper functions
  function escapeHtml(text) {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  function getTimeAgo(timestamp) {
    const now = new Date();
    const posted = new Date(timestamp);
    const seconds = Math.floor((now - posted) / 1000);

    if (seconds < 60) return `${seconds}s`;
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h`;
    if (seconds < 604800) return `${Math.floor(seconds / 86400)}d`;

    return posted.toLocaleDateString();
  }

  // Load posts on page load
  loadPosts();
</script>
{% endblock %}
